name: Build Github-Runner

# When this action will be executed
on:
  # Automatically trigger it when detected changes in repo
  push:
    branches: 
      [ master ]
    paths:
    - '**'
  # Allow manual trigger 
  workflow_dispatch:
      
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # - name: Get token from Github App
      #   uses: actions/create-github-app-token@v1
      #   id: app_token
      #   with:
      #     app-id: ${{ secrets.HEMI_GITHUB_APP_ID }}
      #     private-key: ${{ secrets.HEMI_GITHUB_APP_PK }}
      #     # owner is required, otherwise the creds will fail the checkout step
      #     owner: ${{ github.repository_owner }}
          
      - name: Checkout to the branch
        uses: actions/checkout@v2
        

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.TEALCOMPAPIDEV_AZURE_CREDENTIALS }}

      - name: Build and deploy Local Runner For GitHub
        uses: azure/container-apps-deploy-action@v2
        with:
          environmentVariables: RUNNER_SCOPE=org
                                ORG_NAME=TandemCare
                                APP_PRIVATE_KEY=${{ secrets.HEMI_GITHUB_APP_PK }}
                                APP_ID=${{ secrets.HEMI_GITHUB_APP_ID }}
                                TZ="America/New_York"
                                
          registryUrl: tealcompexternal3a4adc.azurecr.io
          registryUsername: ${{ secrets.TEALCOMPAPIDEV_REGISTRY_USERNAME }}
          registryPassword: ${{ secrets.TEALCOMPAPIDEV_REGISTRY_PASSWORD }}
          imageToBuild: tealcompexternal3a4adc.azurecr.io/git-selfhosted:runner-base
          containerAppName: github-hemi-builder
          resourceGroup: harlowe-tealcomp
    

      

